<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>J 48</title>
  <script src="jquery-2.0.3.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
    }
    #error {
      font-size: 108px;
      color: red;
    }
    #times {
      font-size: 216px;
/*      border: solid 1px lime; */
    }
  </style>
</head>
<body>
  <div id="error"></div>
  <div id="times"></div>
  <script>
  function add_leading_zero(seconds) {
    if (seconds >= 10)
      return seconds;
    return "0" + seconds;
  }
  var for_each_fills = [];
  var alignment;
  // TODO: Change alignment from global to a parameter. Pass bound function to forEach.
  function forEach(index, elem) {
    if (elem.attributes['affectedByLayover'] == null ||
        !elem.attributes['affectedByLayover'].value) {
      var seconds = elem.attributes['seconds'].value;
      for_each_fills.push({"seconds": seconds, "align": alignment});
    }
  }
  var success = function(e) {
    $('#error').empty();
    $('#times').empty();
    for_each_fills = [];
    console.log(e);

    alignment = "left";
    directions = $(e).find("predictions[routeTag='J'] > direction[title^='Inbound']");
    predictions = directions.find('prediction');
    predictions.each(forEach);
    alignment = "right";
    directions = $(e).find("predictions[routeTag='48'] > direction[title^='Inbound']");
    predictions = directions.find('prediction');
    predictions.each(forEach);
    for_each_fills = for_each_fills.sort(function(a, b) {
      return a.seconds - b.seconds;
    });
    for (var i = 0; i < for_each_fills.length; i++) {
      var seconds = for_each_fills[i].seconds;
      var to_display = Math.floor(seconds / 60) + "m " + add_leading_zero(seconds % 60) + "s";
      $('#times').append('<div style="text-align:' + for_each_fills[i].align + '">' + to_display + "</div>");
    }

    if (for_each_fills.length == 0) {
//      console.log("nothing");
      $('#times').append('<div>nothing</div>');
    }
  }
  var error = function(e) {
    // TODO: Instead of empty/append, change to replace?
    $('#error').empty();
    $('#error').append("<div>got error: " + JSON.stringify(e, null, 1) + "</div>");
  }
  function fetchNewData() {
    var url = "http://webservices.nextbus.com/service/publicXMLFeed?command=predictionsForMultiStops&a=sf-muni&stops=J|3996&stops=48|3461";
//    url = "dogs.xml";
    var ajaxOptions = {
      url: url,
  //    url: "http://webservices.nextbus.com/service/publicXMLFeed?command=predictions&a=sf-muni&stopId=13996",
      dataType: "xml",
      success: success,
      error: error
    };
    // TODO: Use fetch instead of jquery.
    $.ajax(ajaxOptions);
    setInterval(function() {
      $.ajax(ajaxOptions);
    }, 10 * 1000)
  }
  fetchNewData();
  </script>
</body>
</html>

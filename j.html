<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Demo</title>
  <script src="jquery-2.0.3.js"></script>
  <style>
    #times {
      font-size: 216px;
    }
    #error {
      font-size: 108px;
      color: red;
    }
  </style>
</head>
<body>
  <div id="error"></div>
  <div id="times"></div>
  <script>
  function format(seconds) {
    if (seconds >= 10)
      return seconds;
    return "0" + seconds;
  }
  var for_each_fills = [];
  var alignment;
  function forEach(index, elem) {
    if (elem.attributes['affectedByLayover'] == null ||
        !elem.attributes['affectedByLayover'].value) {
      var seconds = elem.attributes['seconds'].value;
      for_each_fills.push({"seconds": seconds, "align": alignment});
    }
  }
  var success = function(e) {
    $('#error').empty();
    $('#times').empty();
    for_each_fills = [];
//    console.log(e);

    alignment = "left";
    directions = $(e).find("direction[title='Inbound to Downtown']");
    predictions = directions.find('prediction');
    predictions.each(forEach);
    alignment = "right";
    directions = $(e).find("direction[title='Inbound to Potrero Hill']");
    predictions = directions.find('prediction');
    predictions.each(forEach);
    for_each_fills = for_each_fills.sort(function(a, b) {
//      return parseInt(a.seconds, 10) > parseInt(b.seconds, 10);
      return a.seconds - b.seconds;
    });
    for (var i = 0; i < for_each_fills.length; i++) {
      var seconds = for_each_fills[i].seconds;
      var to_display = Math.floor(seconds / 60) + "m " + format(seconds % 60) + "s";
      $('#times').append('<div style="text-align:' + for_each_fills[i].align + '">' + to_display + "</div>");
    }

    if (for_each_fills.length == 0) {
//      console.log("nothing");
      $('#times').append('<div>nothing</div>');
    }
  }
  var error = function(e) {
    // Instead of empty/append, change to replace?
    $('#error').empty();
    $('#error').append("<div>got error: " + JSON.stringify(e, null, 1) + "</div>");
  }
  var ajaxOptions = {
    url: "http://webservices.nextbus.com/service/publicXMLFeed?command=predictionsForMultiStops&a=sf-muni&stops=J|3996&stops=48|3461",
//    url: "http://webservices.nextbus.com/service/publicXMLFeed?command=predictions&a=sf-muni&stopId=13996",
    dataType: "xml",
    success: success,
    error: error
  };
  // Change this to fetch instead of jquery.
  $.ajax(ajaxOptions);
  setInterval(function() {
      $.ajax(ajaxOptions);
  }, 10 * 1000)

  </script>
</body>
</html>
